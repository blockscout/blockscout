name: Public release publishing

on:
  workflow_dispatch:
    inputs:
      release_number:
        description: 'Release number (e.g., v9.1.0, latest)'
        required: true
        type: string

jobs:
  copy-bundle:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - uses: actions/checkout@v5
      - name: Setup repo
        uses: ./.github/actions/setup-repo
        id: setup
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          docker-remote-multi-platform: true
          docker-arm-host: ${{ secrets.ARM_RUNNER_HOSTNAME }}
          docker-arm-host-key: ${{ secrets.ARM_RUNNER_KEY }}

      - name: Set source and target tags
        run: |
          RELEASE_NUMBER="${{ github.event.inputs.release_number || 'latest' }}"
          SOURCE_TAG="${RELEASE_NUMBER}"
          TARGET_TAG="${RELEASE_NUMBER}"
          echo "SOURCE_TAG=${SOURCE_TAG}" >> $GITHUB_ENV
          echo "TARGET_TAG=${TARGET_TAG}" >> $GITHUB_ENV

      - name: Copy chain-specific images from private to public repositories
        run: |
          RELEASE_NUMBER="${{ github.event.inputs.release_number }}"
          
          # Array of chain-specific repositories
          CHAINS=(
            "blockscout"
            "blockscout-arbitrum"
            "blockscout-celo"
            "blockscout-ethereum"
            "blockscout-filecoin"
            "blockscout-fuse"
            "blockscout-xdai"
            "blockscout-optimism"
            "blockscout-zkevm"
            "blockscout-rsk"
            "blockscout-scroll"
            "blockscout-suave"
            "blockscout-zetachain"
            "blockscout-zilliqa"
            "blockscout-zksync"
          )
          
          # Copy each chain-specific image
          for CHAIN in "${CHAINS[@]}"; do
            echo "Copying ${CHAIN}..."
            
            # Copy with the specific release number tag
            docker buildx imagetools create \
              --tag ghcr.io/blockscout/${CHAIN}:${RELEASE_NUMBER} \
              ghcr.io/blockscout/${CHAIN}-private:${RELEASE_NUMBER}
            
            # Also copy with latest tag
            docker buildx imagetools create \
              --tag ghcr.io/blockscout/${CHAIN}:latest \
              ghcr.io/blockscout/${CHAIN}-private:latest
              
            echo "‚úÖ Completed copying ${CHAIN}"
          done

      - name: Verify deployment
        run: |
          RELEASE_NUMBER="${{ github.event.inputs.release_number }}"
          echo "üéâ All bundles successfully copied from private to public repositories"
          echo ""
          echo "üîó All repositories copied:"
          
          CHAINS=(
            "blockscout"
            "blockscout-arbitrum"
            "blockscout-celo"
            "blockscout-ethereum"
            "blockscout-filecoin"
            "blockscout-fuse"
            "blockscout-xdai"
            "blockscout-optimism"
            "blockscout-zkevm"
            "blockscout-rsk"
            "blockscout-scroll"
            "blockscout-suave"
            "blockscout-zetachain"
            "blockscout-zilliqa"
            "blockscout-zksync"
          )
          
          for CHAIN in "${CHAINS[@]}"; do
            echo "  ‚úÖ ${CHAIN}-private -> ${CHAIN} (tags: ${RELEASE_NUMBER}, latest)"
          done
          
          echo ""
          echo "üîç Inspecting main repository images:"
          docker buildx imagetools inspect ghcr.io/blockscout/blockscout:${TARGET_TAG}
          docker buildx imagetools inspect ghcr.io/blockscout/blockscout:latest
