defmodule Explorer.Chain.SmartContract.Proxy.MasterCopy do
  @moduledoc """
  Module for fetching master-copy proxy implementation
  """

  alias Explorer.Chain.SmartContract.Proxy
  alias Explorer.Chain.SmartContract.Proxy.ResolverBehaviour

  @behaviour ResolverBehaviour

  # All known Safe Proxy bytecodes
  # Proxy factory addresses are fetched from https://github.com/safe-global/safe-deployments/tree/main/src/assets
  # Bytecodes are fetched from contract instances created by those factories
  @safe_proxy_v1_0_0 <<0x608060405273FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF600054163660008037600080366000845AF43D6000803E6000811415603D573D6000FD5B3D6000F3FEA165627A7A723058201E7D648B83CFAC072CBCCEFC2FFC62A6999D4A050EE87A721942DE1DA9670DB80029::880>>
  @safe_proxy_v1_1_1 <<0x608060405273FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF600054167FA619486E0000000000000000000000000000000000000000000000000000000060003514156050578060005260206000F35B3660008037600080366000845AF43D6000803E60008114156070573D6000FD5B3D6000F3FEA265627A7A72315820D8A00DC4FE6BF675A9D7416FC2D00BB3433362AA8186B750F76C4027269667FF64736F6C634300050E0032::1360>>
  @safe_proxy_v1_3_0 <<0x608060405273FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF600054167FA619486E0000000000000000000000000000000000000000000000000000000060003514156050578060005260206000F35B3660008037600080366000845AF43D6000803E60008114156070573D6000FD5B3D6000F3FEA2646970667358221220D1429297349653A4918076D650332DE1A1068C5F3E07C5C82360C277770B955264736F6C63430007060033::1368>>
  @safe_proxy_v1_3_0_zksync <<0x000400000000000200000000030100190000006003300270000000360430019700030000004103550002000000010355000000360030019D000100000000001F0000008001000039000000400010043F0000000101200190000000150000C13D000000000100041A00000037021001970000000201000367000000000301043B0000003D0330009C000000590000C13D00000000002004350000003E01000041000000D20001042E0000000001000416000000000110004C000000570000C13D0000000203000367000000400100043D00000000020000310000001F0420018F0000000505200272000000270000613D000000000600001900000005076002100000000008710019000000000773034F000000000707043B00000000007804350000000106600039000000000756004B0000001F0000413D000000000640004C000000360000613D0000000505500210000000000353034F00000000055100190000000304400210000000000605043300000000064601CF000000000646022F000000000303043B0000010004400089000000000343022F00000000034301CF000000000363019F00000000003504350000000003120019000000400030043F000000200220008C000000570000413D00000000010104330000003701100198000000BD0000C13D00000064013000390000003A02000041000000000021043500000044013000390000003B0200004100000000002104350000002401300039000000220200003900000000002104350000003C010000410000000000130435000000040130003900000020020000390000000000210435000000400100043D000000000213004900000084022000390000003603000041000000360420009C0000000002038019000000360410009C000000000103801900000040011002100000006002200210000000000112019F000000D3000104300000000001000019000000D30001043000000000030000310000001F0430018F0000000503300272000000650000613D00000000050000190000000506500210000000000761034F000000000707043B00000000007604350000000105500039000000000635004B0000005E0000413D000000000540004C000000730000613D00000003044002100000000503300210000000000503043300000000054501CF000000000545022F000000000131034F000000000101043B0000010004400089000000000141022F00000000014101CF000000000151019F000000000013043500000000010000310000000003000414000000040420008C000000930000C13D000000030100036700000001020000310000001F0320018F0000000502200272000000840000613D00000000040000190000000505400210000000000651034F000000000606043B00000000006504350000000104400039000000000524004B0000007D0000413D000000000430004C000000BA0000613D00000003033002100000000502200210000000000402043300000000043401CF000000000434022F000000000121034F000000000101043B0000010003300089000000000131022F00000000013101CF000000000141019F0000000000120435000000BA0000013D0000003604000041000000360530009C0000000003048019000000C0033002100000006001100210000000000113001900D100CC0000040F0003000000010355000000000301001900000060043002700000001F0340018F000100360040019D00000036044001970000000504400272000000AA0000613D00000000050000190000000506500210000000000761034F000000000707043B00000000007604350000000105500039000000000645004B000000A30000413D000000000530004C000000B80000613D00000003033002100000000504400210000000000504043300000000053501CF000000000535022F000000000141034F000000000101043B0000010003300089000000000131022F00000000013101CF000000000151019F00000000001404350000000101200190000000C60000613D000000600100003900000001011001FF000000D20001042E000000000200041A0000003802200197000000000112019F000000000010041B0000002001000039000001000010044300000120000004430000003901000041000000D20001042E00000036010000410000000102000031000000360320009C00000000010240190000006001100210000000D300010430000000CF002104250000000102000039000000000001042D0000000002000019000000000001042D000000D100000432000000D20001042E000000D300010430000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000002000000000000000000000000000000400000010000000000000000006564000000000000000000000000000000000000000000000000000000000000496E76616C69642073696E676C65746F6E20616464726573732070726F76696408C379A000000000000000000000000000000000000000000000000000000000A619486E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ACBE897875BB4F3E88089713FAB44968F091FDEB912D0AFADD2FE5700E4E0CC6::16640>>
  @safe_proxy_v1_4_1 <<0x608060405273FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF600054167FA619486E0000000000000000000000000000000000000000000000000000000060003514156050578060005260206000F35B3660008037600080366000845AF43D6000803E60008114156070573D6000FD5B3D6000F3FEA264697066735822122003D1488EE65E08FA41E58E888A9865554C535F2C77126A82CB4C0F917F31441364736F6C63430007060033::1368>>
  @safe_proxy_v1_4_1_zksync <<0x00010000000000020000008004000039000000400040043F000000000301001900000060033002700000002E033001970000000100200190000000100000C13D000000000200041A0000003002200197000000000401043B000000360040009C0000004B0000C13D000000000020043F0000003701000041000000B40001042E0000000002000416000000000002004B000000490000C13D0000001F0530018F0000002F0630019800000080026000390000001C0000613D000000000701034F000000007807043C0000000004840436000000000024004B000000180000C13D000000000005004B000000290000613D000000000161034F0000000304500210000000000502043300000000054501CF000000000545022F000000000101043B0000010004400089000000000141022F00000000014101CF000000000151019F00000000001204350000008001300039000000400010043F000000200030008C000000490000413D000000800200043D0000003002200198000000A30000C13D00000033020000410000000000210435000000E40130003900000034020000410000000000210435000000C40130003900000035020000410000000000210435000000A40130003900000022020000390000000000210435000000840130003900000020020000390000000000210435000000400100043D000000000213004900000104022000390000002E0020009C0000002E0200804100000060022002100000002E0010009C0000002E010080410000004001100210000000000112019F000000B5000104300000000001000019000000B5000104300000001F0530018F0000002F04300198000000540000613D000000000601034F0000000007000019000000006806043C0000000007870436000000000047004B000000500000C13D000000000005004B000000610000613D000000000641034F0000000305500210000000000704043300000000075701CF000000000757022F000000000606043B0000010005500089000000000656022F00000000055601CF000000000575019F00000000005404350000000004000414000000040020008C0000007D0000C13D000000000331034F000000000100003100000038021001980000001F0410018F0000006F0000613D000000000503034F0000000006000019000000005705043C0000000006760436000000000026004B0000006B0000C13D000000000004004B0000009F0000613D000000000323034F0000000304400210000000000502043300000000054501CF000000000545022F000000000303043B0000010004400089000000000343022F00000000034301CF000000000353019F00000000003204350000009F0000013D00000060013002100000002E0040009C0000002E04008041000000C003400210000000000113019F00B300AE0000040F000000000301001900000060033002700000001F0530018F0000002E0030019D0000002F043001980000008F0000613D000000000601034F0000000007000019000000006806043C0000000007870436000000000047004B0000008B0000C13D000000000005004B0000009C0000613D000000000141034F0000000305500210000000000604043300000000065601CF000000000656022F000000000101043B0000010005500089000000000151022F00000000015101CF000000000161019F00000000001404350000002E013001970000000100200190000000AC0000613D0000002E0010009C0000002E010080410000006001100210000000B40001042E000000000100041A0000003101100197000000000121019F000000000010041B0000002001000039000001000010044300000120000004430000003201000041000000B40001042E0000006001100210000000B500010430000000B1002104250000000102000039000000000001042D0000000002000019000000000001042D000000B300000432000000B40001042E000000B5000104300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF00000000000000000000000000000000000000000000000000000000FFFFFFE0000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000020000000000000000000000000000004000000100000000000000000008C379A0000000000000000000000000000000000000000000000000000000006564000000000000000000000000000000000000000000000000000000000000496E76616C69642073696E676C65746F6E20616464726573732070726F766964A619486E000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE000000000000000000000000000000000000000000000000000000000000000004D3D6AC1CA9BD3D9AB93E603DE7967DA33803409D7B4500E28F36CE7E4DD5A21::15104>>
  @safe_proxy_v1_5_0 <<0x608060405260005463A619486E60003560E01C14156024578060601B606C5260206060F35B3660008037600080366000845AF43D6000803E806040573D6000FD5B3D6000F3FEA2646970667358221220E61834EBD2D8CD909D362BF67C47EF58FD665DF38E6DD036CE65611101D072E964736F6C63430007060033::984>>

  def quick_resolve_implementations(proxy_address, _proxy_type) do
    with true <-
           proxy_address.contract_code &&
             proxy_address.contract_code.bytes in [
               @safe_proxy_v1_0_0,
               @safe_proxy_v1_1_1,
               @safe_proxy_v1_3_0,
               @safe_proxy_v1_3_0_zksync,
               @safe_proxy_v1_4_1,
               @safe_proxy_v1_4_1_zksync,
               @safe_proxy_v1_5_0
             ],
         {:ok, value} <- Proxy.fetch_value({:storage, "0x0"}, proxy_address.hash),
         {:ok, address_hash} <- Proxy.extract_address_hash(value) do
      {:ok, [address_hash]}
    else
      :error -> :error
      # proceed to other proxy types only if bytecode doesn't match
      false -> nil
      # if bytecode matches but resolution fails, we should halt
      _ -> {:ok, []}
    end
  end
end
